<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sale Pipe Formatter</title>
  <link rel="icon" href="pipe.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --accent: #0f858e;
      --accent-light: #20a6b3;

      /* Light theme */
      --bg: #eaf4f5;
      --text: #333;
      --glass-bg: #ffffff;
      --shadow: 0 8px 25px rgba(0, 0, 0, 0.08);

      --border: #000;
      --muted: #666;
      --panel-border: #eee;
      --input-bg: #fff;
      --input-text: #000;
      --token-hover: rgba(15,133,142,0.1);
      --footer: #555;
      --pipe-opacity: 0.25;

      /* Win95 modal */
      --w95-border: #cfcfcf;
      --w95-inset1: #ffffff;
      --w95-inset2: #9a9a9a;
      --backdrop: rgba(0,0,0,0.25);

      /* Scrollbar theme (light) */
      --sb-track: rgba(0,0,0,0.06);
      --sb-thumb: rgba(15,133,142,0.45);
      --sb-thumb-hover: rgba(15,133,142,0.65);
      --sb-size: 10px;

      /* Split separator line */
      --split-line: rgba(0,0,0,0.14);

      /* Settings card */
      --settings-width: 180px;
      --settings-pad: 8px;
      --settings-row-gap: 6px;

      /* Copied overlay color */
      --copied-overlay-color: rgba(0,0,0,0.35);
    }

    body.dark {
      --bg: #151c21;
      --text: #eef4f7;
      --glass-bg: #1c252b;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.42);

      --border: #3a4a54;
      --muted: #b4c2cb;
      --panel-border: #2d3b44;
      --input-bg: #151c21;
      --input-text: #eef4f7;

      --token-hover: rgba(32,166,179,0.20);
      --footer: #b4c2cb;
      --pipe-opacity: 0.17;

      --w95-border: #3a4a54;
      --w95-inset1: #26323a;
      --w95-inset2: #0f1418;
      --backdrop: rgba(0,0,0,0.50);

      --sb-track: rgba(255,255,255,0.06);
      --sb-thumb: rgba(32,166,179,0.35);
      --sb-thumb-hover: rgba(32,166,179,0.55);

      --split-line: rgba(255,255,255,0.14);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", sans-serif;
      background-color: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      position: relative;
      padding: 20px;
      transition: background-color 0.25s ease, color 0.25s ease;
    }

    .hidden { display: none !important; }

    /* Hide footer while any Win95 modal is open */
    body.modal-open footer { display: none; }

    /* Clean scrollbars (Chrome/Edge/Safari) */
    *::-webkit-scrollbar { width: var(--sb-size); height: var(--sb-size); }
    *::-webkit-scrollbar-track { background: var(--sb-track); border-radius: 999px; }
    *::-webkit-scrollbar-thumb {
      background: var(--sb-thumb);
      border-radius: 999px;
      border: 2px solid transparent;
      background-clip: padding-box;
    }
    *::-webkit-scrollbar-thumb:hover {
      background: var(--sb-thumb-hover);
      border: 2px solid transparent;
      background-clip: padding-box;
    }
    /* Clean scrollbars (Firefox) */
    * { scrollbar-width: thin; scrollbar-color: var(--sb-thumb) var(--sb-track); }

    /* === RAINING PIPES === */
    .pipe-background {
      position: absolute;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
    }

    .pipe {
      position: absolute;
      width: 30px;
      height: auto;
      animation: fall linear infinite;
      opacity: var(--pipe-opacity);
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.15));
    }

    @keyframes fall {
      0% { transform: translateY(-100px); opacity: 0; }
      10% { opacity: var(--pipe-opacity); }
      100% { transform: translateY(110vh); opacity: var(--pipe-opacity); }
    }

    /* === BUTTONS === */
    .button {
      padding: 0.75em 1.6em;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      cursor: pointer;
      color: var(--accent);
      transition: all 0.4s ease;
      font-size: 14px;
      position: relative;
      overflow: hidden;
      outline: 2px solid var(--accent);
      background: transparent;
      display: inline-block;
      white-space: nowrap;
    }

    .button:hover {
      color: #fff;
      transform: scale(1.05);
      outline: 2px solid var(--accent-light);
      box-shadow: 2px 4px 10px -2px #0d6c75;
    }

    .button::before {
      content: "";
      position: absolute;
      left: -50px;
      top: 0;
      width: 0;
      height: 100%;
      background-color: var(--accent);
      transform: skewX(45deg);
      z-index: -1;
      transition: width 0.5s ease;
    }
    .button:hover::before { width: 250%; }

    /* Batch buttons: identical styling */
    .batch-copy-btn {
      padding: 0.75em 1.6em;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      cursor: pointer;
      color: var(--accent);
      transition: all 0.4s ease;
      font-size: 14px;
      position: relative;
      overflow: hidden;
      outline: 2px solid var(--accent);
      background: transparent;
      display: inline-block;
      white-space: nowrap;
    }

    .batch-copy-btn:hover {
      color: #fff;
      transform: scale(1.05);
      outline: 2px solid var(--accent-light);
      box-shadow: 2px 4px 10px -2px #0d6c75;
    }

    .batch-copy-btn::before {
      content: "";
      position: absolute;
      left: -50px;
      top: 0;
      width: 0;
      height: 100%;
      background-color: var(--accent);
      transform: skewX(45deg);
      z-index: -1;
      transition: width 0.5s ease;
    }
    .batch-copy-btn:hover::before { width: 250%; }

    .menu-buttons {
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 10;
      display: flex;
      gap: 10px;
    }

    .header-right {
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 10;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
      max-width: calc(100vw - 30px);
    }

    .settings-card{
      width: var(--settings-width);
      padding: var(--settings-pad);
      border-radius: 12px;
      border: 1px solid var(--panel-border);
      background: color-mix(in srgb, var(--glass-bg) 85%, transparent);
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      transition: background-color 0.25s ease, border-color 0.25s ease;
      text-align: left;
      margin-top: -3px;
    }
    .settings-divider {
      height: 0;
      border-top: 1px solid var(--panel-border);
      margin: 8px 0 8px;
    }

    /* === MOTIVATION SCROLLER === */
    .headline-scroller {
      position: fixed;
      top: 120px;
      left: 0;
      right: 0;
      width: 100%;
      overflow: hidden;
      z-index: 1;
      pointer-events: none;
      height: 30px;
      display: block;
      background: transparent;
      color: var(--accent);
      font-weight: 600;
      font-size: 16px;
      white-space: nowrap;
    }

    .headline-text {
      display: inline-block;
      white-space: nowrap;
      will-change: transform;
      transform: translateX(100%);
    }

    /* ============================================================
       ✅ Layout wrapper (no glass) + 2 separate glass cards
       ============================================================ */
    .container {
      position: relative;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 1120px;
      z-index: 2;
      display: flex;
      justify-content: center;
      transition: max-width 0.25s ease;
    }
    .container:not(.dual) { max-width: 520px; }

    .panels {
      width: 100%;
      display: flex;
      gap: 18px;
      align-items: flex-start;
      justify-content: center;
    }

    .panel { width: 100%; display: block; }
    .panel.secondary.hidden { display: none !important; }

    .panel-card {
      background: var(--glass-bg);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 30px 25px;
      width: 100%;
      max-width: 520px;
      text-align: center;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      animation: fadeIn 0.6s ease;
      transition: background-color 0.25s ease, box-shadow 0.25s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h2 { margin-bottom: 8px; font-weight: 700; color: var(--accent); }
    p { margin-top: 0; font-size: 14px; color: var(--text); opacity: 0.95; }

    .qtyMarker { align-self: flex-start; font-size: 14px; color: var(--text); margin-bottom: 5px; }

    .inputText {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      outline: none;
      text-align: center;
      background: var(--input-bg);
      color: var(--input-text);
      caret-color: transparent;
      transition: background-color 0.25s ease, color 0.25s ease, border-color 0.25s ease;
    }
    .inputText:focus { outline: none; }

    .output-container {
      margin-top: 20px;
      max-height: 150px;
      overflow-y: auto;
      overflow-x: hidden;
      border: 1px solid var(--border);
      padding: 12px;
      background: var(--input-bg);
      text-align: center;
      font-weight: 600;
      font-size: 16px;
      border-radius: 10px;
      display: none;
      width: 100%;
      color: var(--accent);
      overflow-wrap: anywhere;
      word-break: break-word;
      transition: background-color 0.25s ease, border-color 0.25s ease;
    }

    .splitOutputsMount {
      width: 100%;
      display: none;
      max-height: 320px;
      overflow-y: auto;
      overflow-x: hidden;
      margin-top: 10px;
      padding-right: 8px;
      padding-bottom: 22px;
    }

    .button-container {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .split-under-main-buttons {
      width: 100%;
      height: 0;
      border-top: 1px solid var(--split-line);
      margin: 12px 0 2px;
      display: none;
    }

    .split-sep {
      width: 100%;
      height: 0;
      border-top: 1px solid var(--split-line);
      margin: 12px 0 6px;
    }

    .group-label {
      width: 100%;
      margin-top: 2px;
      margin-bottom: 4px;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--muted);
      text-align: left;
      padding: 0 2px;
      user-select: none;
    }

    /* === Modals (Remove/Duplicates) === */
    .remove-modal, .duplicate-modal {
      background: var(--glass-bg);
      border-radius: 10px;
      box-shadow: var(--shadow);
      padding: 15px;
      z-index: 3;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease, background-color 0.25s ease;
      position: absolute;
      border: 1px solid var(--panel-border);
    }
    .remove-modal.visible, .duplicate-modal.visible { opacity: 1; visibility: visible; }

    /* single-mode placement like before */
    .remove-modal {
      top: 50%;
      left: 0;
      transform: translate(-115%, -50%);
      width: 260px;
      text-align: center;
    }

    .duplicate-modal {
      top: 50%;
      right: 0;
      transform: translate(115%, -50%);
      width: 260px;
      text-align: left;
      padding: 15px 15px 28px;
    }

    .duplicate-modal h4 { margin: 0 0 8px; font-size: 14px; color: var(--accent); }
    .duplicateList { font-size: 13px; color: var(--text); max-height: 120px; overflow-y: auto; }

    /* dual mode: keep those modals INSIDE each card */
    .container.dual .remove-modal,
    .container.dual .duplicate-modal {
      position: static;
      transform: none;
      width: 100%;
      margin: 10px 0 0 0;
      text-align: left;
      padding: 12px;
    }

    /* switches */
    .toggle-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      border-bottom: 1px solid var(--panel-border);
      padding-bottom: 8px;
    }

    .switch { position: relative; display: inline-block; width: 38px; height: 20px; }
    .switch input { opacity: 0; width: 0; height: 0; }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 999px;
    }

    .slider:before {
      content: "";
      position: absolute;
      height: 14px;
      width: 14px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    input:checked + .slider { background-color: var(--accent); }
    input:checked + .slider:before { transform: translateX(18px); }

    footer {
      position: fixed;
      bottom: 10px;
      right: 15px;
      font-size: 12px;
      color: var(--footer);
      font-style: italic;
      z-index: 2;
    }

    /* Clickable tokens */
    .num-token, .dup-token, .dup-line-token {
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 4px;
      transition: background-color 0.2s ease, color 0.2s ease;
    }
    .num-token:hover, .dup-token:hover, .dup-line-token:hover { background-color: var(--token-hover); }
    .num-token.highlight, .dup-token.highlight, .dup-line-token.highlight {
      background-color: var(--accent-light);
      color: #fff;
    }

    /* Duplicate numbers line scroll area */
    .duplicateCopyWrapper {
      max-width: 240px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }

    .duplicateCopyText {
      max-height: 200px;
      max-width: 240px;
      overflow-y: auto;
      overflow-x: hidden;
      white-space: normal;
      display: block;
      padding: 6px 8px;
      padding-right: 12px;
      border: 1px solid var(--panel-border);
      border-radius: 6px;
      background: var(--input-bg);
      color: var(--text);
      transition: background-color 0.25s ease, border-color 0.25s ease, color 0.25s ease;
    }

    .dup-line-token { display: inline-block; margin-right: 4px; }

    /* ===== Windows 95 themed modals ===== */
    .w95-backdrop {
      position: fixed;
      inset: 0;
      background: var(--backdrop);
      z-index: 999;
    }

    .w95-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: min(420px, 92vw);
      z-index: 1000;

      background: var(--glass-bg);
      border: 2px solid var(--w95-border);
      box-shadow:
        0 0 0 1px var(--w95-inset1) inset,
        0 0 0 2px var(--w95-inset2) inset,
        0 10px 30px rgba(0,0,0,0.18);
      border-radius: 4px;
      transition: background-color 0.25s ease, border-color 0.25s ease;
    }

    .w95-titlebar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 8px;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      letter-spacing: 0.5px;
      user-select: none;
    }

    .w95-title { font-size: 13px; }

    .w95-x {
      width: 26px;
      height: 22px;
      padding: 0;
      border: 2px solid var(--w95-border);
      background: #dcdcdc;
      color: #111;
      font-weight: 800;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 1px var(--w95-inset1) inset, 0 0 0 2px var(--w95-inset2) inset;
    }

    .w95-x:hover { background: #efefef; }
    .w95-x:active {
      box-shadow: 0 0 0 1px var(--w95-inset2) inset, 0 0 0 2px var(--w95-inset1) inset;
      transform: translateY(1px);
    }

    body.dark .w95-x { background: var(--glass-bg); color: var(--text); }
    body.dark .w95-x:hover { background: color-mix(in srgb, var(--glass-bg) 80%, #ffffff 20%); }

    .w95-body { padding: 18px 16px 16px; text-align: center; color: var(--text); }

    .w95-message {
      font-size: 16px;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 14px;
    }

    .w95-btn-row {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }

    .w95-btn {
      min-width: 130px;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 800;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      cursor: pointer;
      background: #fff;
      color: var(--accent);
      border: 2px solid var(--w95-border);
      box-shadow:
        0 0 0 1px var(--w95-inset1) inset,
        0 0 0 2px var(--w95-inset2) inset;
      border-radius: 4px;
    }

    body.dark .w95-btn { background: var(--input-bg); color: var(--accent-light); }

    .w95-btn:active {
      box-shadow: 0 0 0 1px var(--w95-inset2) inset, 0 0 0 2px var(--w95-inset1) inset;
      transform: translateY(1px);
    }

    .removeText {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--input-text);
      transition: background-color 0.25s ease, color 0.25s ease, border-color 0.25s ease;
    }

    @media (max-width: 520px) {
      .header-right { flex-direction: column; align-items: flex-end; }
      .settings-card { width: min(170px, 92vw); margin-top: 0; }
      .container { margin-top: 170px; }
    }

    @media (max-width: 980px) {
      body { overflow: auto; }
      .panels { flex-direction: column; }
      .container { top: 0; left: 0; transform: none; margin: 160px auto 40px; }
      .header-right { flex-direction: column; align-items: flex-end; }
      .settings-card { width: min(var(--settings-width), 92vw); margin-top: 0; }
    }

    /* =======================================================================
       Smooth Copied Toast
       ======================================================================= */
    .copied-toast {
      position: fixed;
      inset: 0;
      z-index: 3000;
      pointer-events: none;
      display: grid;
      place-items: center;

      opacity: 0;
      visibility: hidden;
      transition: opacity 140ms ease, visibility 0s linear 140ms;
    }

    .copied-toast.show {
      opacity: 1;
      visibility: visible;
      transition: opacity 120ms ease, visibility 0s linear 0s;
    }

    .copied-toast .overlay {
      position: absolute;
      inset: 0;
      background: var(--copied-overlay-color);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      opacity: 0;
    }

    .word-container {
      position: relative;
      height: 120px;
      width: min(520px, 92vw);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 1;
      transform: translate3d(0,0,0);
      will-change: transform, opacity;
    }

    .half {
      position: absolute;
      font-size: clamp(34px, 6vw, 72px);
      color: #20a6b3;
      white-space: nowrap;
      text-shadow: 0 10px 30px rgba(0,0,0,0.30);
      letter-spacing: 2px;
      font-weight: 900;
      text-transform: uppercase;
      backface-visibility: hidden;
      transform: translate3d(0,0,0);
      will-change: clip-path, transform, opacity;
      opacity: 0;
    }

    .left  { clip-path: inset(0 50% 0 0); }
    .right { clip-path: inset(0 0 0 50%); }

    .copied-toast.play .overlay { animation: overlayFade 650ms ease forwards; }

    .copied-toast.play .left {
      animation:
        popIn 0.14s ease-out forwards,
        wipeLeft 0.55s cubic-bezier(0.45, 0, 0.55, 1) 0.22s forwards;
    }

    .copied-toast.play .right {
      animation:
        popIn 0.14s ease-out forwards,
        wipeRight 0.55s cubic-bezier(0.45, 0, 0.55, 1) 0.22s forwards;
    }

    @keyframes popIn {
      0%   { transform: translate3d(0,0,0) scale(0.92); opacity: 0; }
      100% { transform: translate3d(0,0,0) scale(1); opacity: 1; }
    }

    @keyframes wipeLeft {
      0%   { clip-path: inset(0 50% 0 0); opacity: 1; }
      100% { clip-path: inset(0 100% 0 0); opacity: 0; }
    }

    @keyframes wipeRight {
      0%   { clip-path: inset(0 0 0 50%); opacity: 1; }
      100% { clip-path: inset(0 0 0 100%); opacity: 0; }
    }

    @keyframes overlayFade {
      0%   { opacity: 0; }
      10%  { opacity: 1; }
      75%  { opacity: 1; }
      100% { opacity: 0; }
    }

    @media (prefers-reduced-motion: reduce) {
      .copied-toast.play .overlay { animation: none; opacity: 0.65; }
      .copied-toast.play .left,
      .copied-toast.play .right { animation: none; opacity: 1; }
    }
  </style>
</head>

<body>

  <div class="menu-buttons">
    <button class="button" onclick="location.href='/'">Home</button>
    <button class="button" onclick="location.href='date'">Dates</button>
    <button class="button" onclick="location.href='pipes'">Pipe Formatter</button>
  </div>

  <div class="header-right">
    <button class="button" onclick="exportCSV()">Export CSV</button>

    <div class="settings-card" aria-label="Settings">
      <div class="toggle-container" style="border-bottom:none; padding-bottom:0; margin-bottom:6px;">
        <span style="font-size:11px; font-weight:700; color:var(--muted); letter-spacing:1px; text-transform:uppercase;">
          Options
        </span>
      </div>

      <div class="toggle-container" style="margin-bottom: var(--settings-row-gap); border-bottom:none; padding-bottom:0;">
        <span>Dark Mode</span>
        <label class="switch">
          <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
          <span class="slider"></span>
        </label>
      </div>

      <div class="settings-divider"></div>

      <div class="toggle-container" style="margin-bottom: var(--settings-row-gap); border-bottom:none; padding-bottom:0;">
        <span class="toggle-label">Keep Duplicates</span>
        <label class="switch">
          <input type="checkbox" id="keepDuplicatesToggle" onchange="formatText()">
          <span class="slider"></span>
        </label>
      </div>

      <div class="toggle-container" style="margin-bottom: var(--settings-row-gap); border-bottom:none; padding-bottom:0;">
        <span class="toggle-label">Split into 99s</span>
        <label class="switch">
          <input type="checkbox" id="split99Toggle" onchange="onSplit99Toggle()">
          <span class="slider"></span>
        </label>
      </div>

      <div class="toggle-container" style="margin-bottom: var(--settings-row-gap); border-bottom:none; padding-bottom:0;">
        <span class="toggle-label">SL-O</span>
        <label class="switch">
          <input type="checkbox" id="sloToggle" onchange="formatText()">
          <span class="slider"></span>
        </label>
      </div>

      <div class="settings-divider"></div>

      <!-- ✅ Secondary toggle -->
      <div class="toggle-container" style="margin-bottom: 0; border-bottom:none; padding-bottom:0;">
        <span class="toggle-label">Secondary</span>
        <label class="switch">
          <input type="checkbox" id="secondaryToggle" onchange="toggleSecondary()">
          <span class="slider"></span>
        </label>
      </div>
    </div>
  </div>

  <div class="pipe-background" id="pipeBackground"></div>

  <div class="headline-scroller">
    <div class="headline-text" id="headlineText">Loading motivation...</div>
  </div>

  <!-- Wrapper (no glass) -->
  <div class="container" id="mainContainer">
    <div class="panels" id="panelsWrap">

      <!-- =========================
           PRIMARY CARD
           ========================= -->
      <div class="panel primary" id="panelPrimary">
        <div class="panel-card">
          <div class="panel-inner">

            <div class="remove-modal" id="removeModal">
              <label for="removeText" style="font-weight:600;">Remove Order Numbers:</label>
              <div style="font-size: 12px; color: var(--muted); margin-bottom: 5px;">Don’t use | here</div>
              <input class="removeText" type="text" id="removeText" placeholder="Type numbers to remove" oninput="formatText()" />
            </div>

            <h2>Paste sales number here</h2>
            <p>Ensure spaces between each sales number</p>
            <div id="qtyMarker" class="qtyMarker">Qty: 0</div>
            <input class="inputText" type="text" id="inputText" placeholder="Enter text here" oninput="formatText()" />

            <div class="button-container" id="mainButtons">
              <button class="button" id="pasteButton" onclick="pasteTextFor('')">Paste</button>
              <button class="button" id="copyButton" onclick="copyTextFor('')" style="display:none;">Copy</button>
              <button class="button" id="clearButton" onclick="requestClearFor('')" style="display:none;">Clear</button>
            </div>

            <div id="splitUnderLine" class="split-under-main-buttons"></div>

            <div class="output-container" id="outputText"></div>
            <div id="splitOutputsMount" class="splitOutputsMount"></div>

            <div class="duplicate-modal" id="duplicateModal">
              <h4>Removed Duplicates</h4>

              <div id="duplicateList" class="duplicateList">None</div>

              <div id="duplicateCopyWrapper" class="duplicateCopyWrapper hidden" style="margin-top:10px; font-size:12px;">
                <div id="duplicateCopyLabel" style="font-weight:600;">Duplicate numbers line:</div>
                <div id="duplicateCopyText" class="duplicateCopyText">None</div>
                <button class="button" type="button" style="padding:4px 10px; font-size:11px;" onclick="copyDuplicatesFor('')">
                  Copy duplicates
                </button>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- =========================
           SECONDARY CARD
           ========================= -->
      <div class="panel secondary hidden" id="panelSecondary">
        <div class="panel-card">
          <div class="panel-inner">

            <div class="remove-modal" id="removeModal2">
              <label for="removeText2" style="font-weight:600;">Remove Order Numbers:</label>
              <div style="font-size: 12px; color: var(--muted); margin-bottom: 5px;">Don’t use | here</div>
              <input class="removeText" type="text" id="removeText2" placeholder="Type numbers to remove" oninput="formatText()" />
            </div>

            <h2>Paste sales number here</h2>
            <p>Ensure spaces between each sales number</p>
            <div id="qtyMarker2" class="qtyMarker">Qty: 0</div>
            <input class="inputText" type="text" id="inputText2" placeholder="Enter text here" oninput="formatText()" />

            <div class="button-container" id="mainButtons2">
              <button class="button" id="pasteButton2" onclick="pasteTextFor('2')">Paste</button>
              <button class="button" id="copyButton2" onclick="copyTextFor('2')" style="display:none;">Copy</button>
              <button class="button" id="clearButton2" onclick="requestClearFor('2')" style="display:none;">Clear</button>
            </div>

            <div id="splitUnderLine2" class="split-under-main-buttons"></div>

            <div class="output-container" id="outputText2"></div>
            <div id="splitOutputsMount2" class="splitOutputsMount"></div>

            <div class="duplicate-modal" id="duplicateModal2">
              <h4>Removed Duplicates</h4>

              <div id="duplicateList2" class="duplicateList">None</div>

              <div id="duplicateCopyWrapper2" class="duplicateCopyWrapper hidden" style="margin-top:10px; font-size:12px;">
                <div id="duplicateCopyLabel2" style="font-weight:600;">Duplicate numbers line:</div>
                <div id="duplicateCopyText2" class="duplicateCopyText">None</div>
                <button class="button" type="button" style="padding:4px 10px; font-size:11px;" onclick="copyDuplicatesFor('2')">
                  Copy duplicates
                </button>
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- === Less than/equal 99 modal (Win95 style) === -->
  <div id="lt99Backdrop" class="w95-backdrop hidden" aria-hidden="true"></div>
  <div id="lt99Modal" class="w95-modal hidden" role="dialog" aria-modal="true"
       aria-labelledby="lt99Title" aria-describedby="lt99Msg">
    <div class="w95-titlebar">
      <div id="lt99Title" class="w95-title">Warning</div>
      <button class="w95-x" type="button" onclick="hideLt99Modal()" aria-label="Close">✕</button>
    </div>

    <div class="w95-body">
      <div id="lt99Msg" class="w95-message">Less than 99</div>

      <div class="w95-btn-row">
        <button id="lt99CloseBtn" class="w95-btn" type="button" onclick="hideLt99Modal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Confirm Clear modal (Win95 style) -->
  <div id="clearBackdrop" class="w95-backdrop hidden" aria-hidden="true"></div>
  <div id="clearModal" class="w95-modal hidden" role="dialog" aria-modal="true"
       aria-labelledby="clearTitle" aria-describedby="clearMsg">
    <div class="w95-titlebar">
      <div id="clearTitle" class="w95-title">Confirm</div>
      <button class="w95-x" type="button" onclick="hideClearModal()" aria-label="Close">✕</button>
    </div>

    <div class="w95-body">
      <div id="clearMsg" class="w95-message">Clear?</div>

      <div class="w95-btn-row">
        <button class="w95-btn" type="button" onclick="confirmClear()">Yes, Clear</button>
        <button class="w95-btn" type="button" onclick="hideClearModal()">Cancel</button>
      </div>
    </div>
  </div>

  <footer>Please note qty may not reflect the actual number</footer>

  <!-- Copied toast -->
  <div id="copiedToast" class="copied-toast" aria-hidden="true">
    <div class="overlay" aria-hidden="true"></div>
    <div class="word-container" aria-hidden="true">
      <div id="copiedLeft" class="half left">COPIED</div>
      <div id="copiedRight" class="half right">COPIED</div>
    </div>
  </div>

  <!-- Paste fallback -->
  <textarea id="pasteFallback" aria-hidden="true"
    style="position:fixed; left:-9999px; top:-9999px; width:1px; height:1px; opacity:0;"></textarea>

<script>
/* =========================================================
   Per-panel state (primary suffix "" and secondary suffix "2")
   ========================================================= */
const panelState = {
  "":  { itemCounts:{}, currentOutputParts:[], duplicateLine:"" },
  "2": { itemCounts:{}, currentOutputParts:[], duplicateLine:"" }
};

let lt99ModalOpen = false;
let clearModalOpen = false;

let split99JustPressed = false;          // used to decide modal vs silent untoggle
let _pendingClearSuffix = "";            // "" or "2"

/* =========================
   Secondary toggle
   ========================= */
function isSecondaryOn() {
  return !!document.getElementById('secondaryToggle')?.checked;
}

function toggleSecondary() {
  const on = isSecondaryOn();
  const panel = document.getElementById('panelSecondary');
  const container = document.getElementById('mainContainer');

  if (on) {
    panel.classList.remove('hidden');
    container.classList.add('dual');
    try { localStorage.setItem('sp_secondary', '1'); } catch {}
    formatText();
    setTimeout(() => document.getElementById('inputText2')?.focus(), 0);
  } else {
    panel.classList.add('hidden');
    container.classList.remove('dual');
    try { localStorage.setItem('sp_secondary', '0'); } catch {}
    formatText();
    setTimeout(() => document.getElementById('inputText')?.focus(), 0);
  }
}

/* =======================================================================
   Auto-clear after 5 minutes of inactivity OR 5 minutes in background tab
   (clears BOTH panels)
   ======================================================================= */
const AUTO_CLEAR_MS = 5 * 60 * 1000;

let _autoClearTimer = null;
let _lastUserActivityAt = Date.now();
let _hiddenSinceAt = document.hidden ? Date.now() : null;

function _setUserActivityNow() {
  _lastUserActivityAt = Date.now();
  _scheduleAutoClearCheck();
}

function _scheduleAutoClearCheck() {
  clearTimeout(_autoClearTimer);

  const now = Date.now();

  const idleRemaining = Math.max(0, AUTO_CLEAR_MS - (now - _lastUserActivityAt));
  const hiddenRemaining = (_hiddenSinceAt == null)
    ? Infinity
    : Math.max(0, AUTO_CLEAR_MS - (now - _hiddenSinceAt));

  const nextIn = Math.min(idleRemaining, hiddenRemaining);
  _autoClearTimer = setTimeout(_autoClearCheck, Math.max(25, nextIn));
}

function _autoClearCheck() {
  const now = Date.now();
  const idleTooLong = (now - _lastUserActivityAt) >= AUTO_CLEAR_MS;
  const hiddenTooLong = (document.hidden && _hiddenSinceAt != null && (now - _hiddenSinceAt) >= AUTO_CLEAR_MS);

  if (idleTooLong || hiddenTooLong) {
    _clearInputsDueToInactivity();
    _lastUserActivityAt = Date.now();
    if (document.hidden) _hiddenSinceAt = Date.now();
    _scheduleAutoClearCheck();
    return;
  }
  _scheduleAutoClearCheck();
}

function _clearInputsDueToInactivity() {
  if (lt99ModalOpen) hideLt99Modal();
  if (clearModalOpen) hideClearModal();

  const input1 = document.getElementById('inputText');
  const remove1 = document.getElementById('removeText');
  if (input1) input1.value = "";
  if (remove1) remove1.value = "";

  const input2 = document.getElementById('inputText2');
  const remove2 = document.getElementById('removeText2');
  if (input2) input2.value = "";
  if (remove2) remove2.value = "";

  formatText();
}

['pointerdown','keydown','wheel','touchstart','scroll'].forEach(evt => {
  window.addEventListener(evt, _setUserActivityNow, { passive: true });
});

document.addEventListener('visibilitychange', () => {
  if (document.hidden) _hiddenSinceAt = Date.now();
  else _hiddenSinceAt = null;
  _scheduleAutoClearCheck();
});
/* ======================================================================= */

function show(el, showFlag) {
  if (showFlag) el.classList.add("visible");
  else el.classList.remove("visible");
}

function setSplitUnderLineVisible(suffix, isVisible) {
  const line = document.getElementById(`splitUnderLine${suffix}`);
  if (!line) return;
  line.style.display = isVisible ? "block" : "none";
}

/* =========================
   Dark mode
   ========================= */
function applyDarkMode(isDark) {
  document.body.classList.toggle('dark', !!isDark);
  const t = document.getElementById('darkModeToggle');
  if (t) t.checked = !!isDark;
}

function toggleDarkMode() {
  const isDark = document.getElementById('darkModeToggle').checked;
  applyDarkMode(isDark);
  try { localStorage.setItem('sp_darkmode', isDark ? '1' : '0'); } catch {}
}

/* helper: hide footer while modal is open */
function setModalOpen(open) {
  document.body.classList.toggle("modal-open", !!open);
}

/* =========================
   Copied toast
   ========================= */
function showCopiedToast(text = "Copied") {
  const toast = document.getElementById("copiedToast");
  const left = document.getElementById("copiedLeft");
  const right = document.getElementById("copiedRight");
  if (!toast || !left || !right) return;

  left.textContent = text;
  right.textContent = text;

  toast.classList.add("show");
  toast.setAttribute("aria-hidden", "false");

  clearTimeout(showCopiedToast._hideT);

  toast.classList.remove("play");
  left.style.animation = "none";
  right.style.animation = "none";

  requestAnimationFrame(() => {
    left.style.animation = "";
    right.style.animation = "";
    toast.classList.add("play");
  });

  showCopiedToast._hideT = setTimeout(() => {
    toast.classList.remove("play");
    toast.classList.remove("show");
    toast.setAttribute("aria-hidden", "true");
  }, 820);
}

/* =========================
   Less-than-99 modal
   ========================= */
function showLt99Modal(msg = "Less than 99") {
  const modal = document.getElementById('lt99Modal');
  const backdrop = document.getElementById('lt99Backdrop');
  const closeBtn = document.getElementById('lt99CloseBtn');
  const msgEl = document.getElementById('lt99Msg');

  if (msgEl) msgEl.textContent = msg;

  setModalOpen(true);

  modal.classList.remove('hidden');
  backdrop.classList.remove('hidden');
  modal.setAttribute('aria-hidden', 'false');
  backdrop.setAttribute('aria-hidden', 'false');

  lt99ModalOpen = true;
  setTimeout(() => closeBtn?.focus(), 0);
}

function hideLt99Modal() {
  const modal = document.getElementById('lt99Modal');
  const backdrop = document.getElementById('lt99Backdrop');

  modal.classList.add('hidden');
  backdrop.classList.add('hidden');
  modal.setAttribute('aria-hidden', 'true');
  backdrop.setAttribute('aria-hidden', 'true');

  lt99ModalOpen = false;

  if (!clearModalOpen) setModalOpen(false);

  const splitToggle = document.getElementById('split99Toggle');
  if (splitToggle) splitToggle.checked = false;

  formatText();

  const input = document.getElementById('inputText');
  if (input) input.focus();
}

/* ✅ Split99 toggle handler (PRIMARY ONLY validation) */
function onSplit99Toggle() {
  const splitToggle = document.getElementById('split99Toggle');
  if (!splitToggle) return;

  // turning OFF
  if (!splitToggle.checked) {
    split99JustPressed = false;
    if (lt99ModalOpen) hideLt99Modal();
    formatText();
    return;
  }

  // turning ON
  split99JustPressed = true;

  // ✅ ONLY validate Primary panel ("") — Secondary is ignored for modal
  const primaryLen = getCurrentPartsForPanel("").length;

  if (primaryLen <= 99) {
    showLt99Modal("Less than 99");
    splitToggle.checked = false;
    split99JustPressed = false;
    formatText();
    return;
  }

  if (lt99ModalOpen) hideLt99Modal();
  formatText();
  split99JustPressed = false;
}

/* =========================
   Clear confirm modal
   ========================= */
function showClearModal(message) {
  const modal = document.getElementById('clearModal');
  const backdrop = document.getElementById('clearBackdrop');
  const msgEl = document.getElementById('clearMsg');

  if (msgEl) msgEl.textContent = message || "Clear?";

  setModalOpen(true);

  modal.classList.remove('hidden');
  backdrop.classList.remove('hidden');
  modal.setAttribute('aria-hidden', 'false');
  backdrop.setAttribute('aria-hidden', 'false');

  clearModalOpen = true;
}

function hideClearModal() {
  const modal = document.getElementById('clearModal');
  const backdrop = document.getElementById('clearBackdrop');

  modal.classList.add('hidden');
  backdrop.classList.add('hidden');
  modal.setAttribute('aria-hidden', 'true');
  backdrop.setAttribute('aria-hidden', 'true');

  clearModalOpen = false;
  if (!lt99ModalOpen) setModalOpen(false);

  document.getElementById('inputText')?.focus();
}

function requestClearFor(suffix) {
  const hasInput = (document.getElementById(`inputText${suffix}`)?.value ?? "").trim().length > 0;
  const hasRemove = (document.getElementById(`removeText${suffix}`)?.value ?? "").trim().length > 0;
  if (!hasInput && !hasRemove) return;

  _pendingClearSuffix = suffix;
  const label = suffix === "2" ? "Secondary" : "Primary";
  showClearModal(`Clear ${label}?`);
}

function confirmClear() {
  hideClearModal();
  clearPanel(_pendingClearSuffix, true);
}

/* Enter/Esc modal controls */
document.addEventListener('keydown', (e) => {
  if (lt99ModalOpen) {
    if (e.key === 'Enter' || e.key === 'Escape') { e.preventDefault(); hideLt99Modal(); }
    return;
  }
  if (clearModalOpen) {
    if (e.key === 'Enter') { e.preventDefault(); confirmClear(); }
    if (e.key === 'Escape') { e.preventDefault(); hideClearModal(); }
  }
});

/* =========================
   CSV cell
   ========================= */
function csvCell(v) {
  const s = String(v ?? "");
  const looksNumeric = /^[0-9]+$/.test(s);
  if (looksNumeric && s.length >= 10) {
    return `"=""${s.replaceAll('"','""')}"""`;
  }
  return `"${s.replaceAll('"','""')}"`;
}

/* =========================
   SL-O helpers
   ========================= */
function isSloOn() {
  return !!document.getElementById('sloToggle')?.checked;
}
function withSloPrefix(v) {
  return isSloOn() ? `OVIUK-${v}` : String(v);
}
function joinWithPrefix(arr, sep='|') {
  return arr.map(withSloPrefix).join(sep);
}

/* Which panels are visible right now? */
function getVisiblePanels() {
  const arr = [""];
  if (isSecondaryOn()) arr.push("2");
  return arr;
}

/* Build tokens exactly how formatter will use them (no DOM changes) */
function getCurrentPartsForPanel(suffix) {
  const input = document.getElementById(`inputText${suffix}`)?.value ?? "";
  const removeInput = document.getElementById(`removeText${suffix}`)?.value.trim() ?? "";
  const keepDuplicates = !!document.getElementById('keepDuplicatesToggle')?.checked;

  let allParts = input
    .replace(/\|/g, ' ')
    .trim()
    .split(/\s+/)
    .filter(Boolean);

  const counts = {};
  allParts.forEach(p => counts[p] = (counts[p] || 0) + 1);

  let parts = keepDuplicates ? allParts : Object.keys(counts);

  if (removeInput) {
    const removeSet = new Set(removeInput.split(/[\s,|]+/).filter(Boolean));
    parts = parts.filter(p => !removeSet.has(p));
  }

  return parts;
}

/* =========================================================
   Main formatter (formats BOTH panels)
   - ✅ Split-99 modal logic is PRIMARY only (handled elsewhere)
   - ✅ Silent untoggle also PRIMARY only
   ========================================================= */
function formatText() {
  const split99 = !!document.getElementById('split99Toggle')?.checked;
  const vis = getVisiblePanels();

  // render all visible panels
  vis.forEach(suffix => formatPanel(suffix));

  // ✅ ONLY Primary panel can force split-off when it drops <= 99
  if (split99 && !split99JustPressed) {
    const primaryParts = panelState[""].currentOutputParts || [];
    if (primaryParts.length <= 99) {
      const splitToggle = document.getElementById('split99Toggle');
      if (splitToggle) splitToggle.checked = false;

      // re-render all visible panels with split off
      vis.forEach(suffix => formatPanel(suffix));
    }
  }
}

/* Format ONE panel and return its parts array */
function formatPanel(suffix) {
  const inputEl = document.getElementById(`inputText${suffix}`);
  const output = document.getElementById(`outputText${suffix}`);
  const splitMount = document.getElementById(`splitOutputsMount${suffix}`);

  const copyBtn = document.getElementById(`copyButton${suffix}`);
  const clearBtn = document.getElementById(`clearButton${suffix}`);
  const pasteBtn = document.getElementById(`pasteButton${suffix}`);
  const qty = document.getElementById(`qtyMarker${suffix}`);

  const removeModal = document.getElementById(`removeModal${suffix}`);
  const duplicateModal = document.getElementById(`duplicateModal${suffix}`);
  const duplicateListDiv = document.getElementById(`duplicateList${suffix}`);

  const split99 = !!document.getElementById('split99Toggle')?.checked;

  const removeInput = document.getElementById(`removeText${suffix}`)?.value.trim() ?? "";
  const input = inputEl?.value ?? "";

  if (input.trim() === "") {
    output.style.display = "none";
    output.innerHTML = "";

    splitMount.style.display = "none";
    splitMount.innerHTML = "";

    setSplitUnderLineVisible(suffix, false);

    copyBtn.style.display = "none";
    clearBtn.style.display = "none";
    pasteBtn.style.display = "inline-block";
    qty.innerText = "Qty: 0";

    show(removeModal, false);
    show(duplicateModal, false);

    duplicateListDiv.innerText = "None";
    renderDuplicateLine(suffix, []);

    panelState[suffix].itemCounts = {};
    panelState[suffix].currentOutputParts = [];
    panelState[suffix].duplicateLine = "";

    return [];
  }

  pasteBtn.style.display = "none";
  copyBtn.style.display = "inline-block";
  clearBtn.style.display = "inline-block";

  show(removeModal, true);
  show(duplicateModal, true);

  let allParts = input
    .replace(/\|/g, ' ')
    .trim()
    .split(/\s+/)
    .filter(Boolean);

  const counts = {};
  allParts.forEach(p => counts[p] = (counts[p] || 0) + 1);
  panelState[suffix].itemCounts = counts;

  const duplicateBlocks = [];
  for (const n in counts) {
    if (counts[n] > 1) {
      duplicateBlocks.push(`
        <div>
          <span class="dup-token" data-num="${n}" onclick="highlightNumber('${n}')">${n}</span><br>
          Removed x${counts[n]-1}<br>
          Appears x${counts[n]}
        </div>
      `);
    }
  }
  duplicateListDiv.innerHTML = duplicateBlocks.length ? duplicateBlocks.join('') : "None";

  const duplicateNumbers = Object.keys(counts).filter(n => counts[n] > 1);
  panelState[suffix].duplicateLine = duplicateNumbers.join('|');
  renderDuplicateLine(suffix, duplicateNumbers);

  const keepDuplicates = !!document.getElementById('keepDuplicatesToggle')?.checked;
  let parts = keepDuplicates ? allParts : Object.keys(counts);

  if (removeInput) {
    const removeSet = new Set(removeInput.split(/[\s,|]+/).filter(Boolean));
    parts = parts.filter(p => !removeSet.has(p));
  }

  panelState[suffix].currentOutputParts = [...parts];
  qty.innerText = `Qty: ${parts.length}`;

  // If split is OFF OR this panel is <=99, show normal output.
  // ✅ This makes Secondary "ignore" the <=99 split modal rule automatically.
  if (!split99 || parts.length <= 99) {
    splitMount.style.display = "none";
    splitMount.innerHTML = "";
    setSplitUnderLineVisible(suffix, false);

    output.style.display = "block";
    renderOutput(suffix, parts);
    return parts;
  }

  // Split ON + >99 => split batches
  output.style.display = "none";
  output.innerHTML = "";

  splitMount.style.display = "block";
  renderSplitOutputs(suffix, parts);

  setSplitUnderLineVisible(suffix, parts.length > 99);
  return parts;
}

function renderOutput(suffix, parts) {
  const outEl = document.getElementById(`outputText${suffix}`);
  outEl.innerHTML = "";
  parts.forEach((p, idx) => {
    const span = document.createElement('span');
    span.className = 'num-token';
    span.dataset.num = p;
    span.textContent = withSloPrefix(p);
    span.onclick = () => highlightNumber(p);
    outEl.appendChild(span);
    if (idx < parts.length-1) outEl.appendChild(document.createTextNode('|'));
  });
}

function renderSplitOutputs(suffix, parts) {
  const mount = document.getElementById(`splitOutputsMount${suffix}`);
  mount.innerHTML = "";

  const groupSize = 99;
  const groups = [];
  for (let i = 0; i < parts.length; i += groupSize) groups.push(parts.slice(i, i + groupSize));

  groups.forEach((group, idx) => {
    if (idx > 0) {
      const sep = document.createElement('div');
      sep.className = 'split-sep';
      mount.appendChild(sep);
    }

    const label = document.createElement('div');
    label.className = 'group-label';
    label.textContent = `Group ${idx + 1} (${group.length})`;
    mount.appendChild(label);

    const outBox = document.createElement('div');
    outBox.className = 'output-container';
    outBox.style.display = "block";

    group.forEach((p, j) => {
      const span = document.createElement('span');
      span.className = 'num-token';
      span.dataset.num = p;
      span.textContent = withSloPrefix(p);
      span.onclick = () => highlightNumber(p);
      outBox.appendChild(span);
      if (j < group.length - 1) outBox.appendChild(document.createTextNode('|'));
    });

    const btnWrap = document.createElement('div');
    btnWrap.className = 'button-container';
    btnWrap.style.marginTop = "10px";

    const copyOne = document.createElement('button');
    copyOne.className = 'batch-copy-btn';
    copyOne.type = 'button';
    copyOne.textContent = `Copy Batch ${idx + 1}`;
    copyOne.onclick = () => {
      navigator.clipboard.writeText(joinWithPrefix(group, '|'));
      showCopiedToast(`Copied Batch ${idx + 1}`);
    };

    btnWrap.appendChild(copyOne);

    mount.appendChild(outBox);
    mount.appendChild(btnWrap);
  });
}

function renderDuplicateLine(suffix, dups) {
  const wrapper = document.getElementById(`duplicateCopyWrapper${suffix}`);
  const container = document.getElementById(`duplicateCopyText${suffix}`);

  if (!dups.length) {
    wrapper.classList.add("hidden");
    container.textContent = "None";
    return;
  }

  wrapper.classList.remove("hidden");
  container.innerHTML = "";

  dups.forEach((n, idx) => {
    const span = document.createElement('span');
    span.className = 'dup-line-token';
    span.dataset.num = n;
    span.textContent = n;
    span.onclick = () => highlightNumber(n);
    container.appendChild(span);
    if (idx < dups.length-1) container.appendChild(document.createTextNode('|'));
  });
}

function highlightNumber(value) {
  const tokens = document.querySelectorAll('.num-token, .dup-token, .dup-line-token');
  tokens.forEach(t => t.classList.toggle('highlight', t.dataset.num === value));
}

function copyDuplicatesFor(suffix) {
  const line = panelState[suffix].duplicateLine;
  if (line) {
    navigator.clipboard.writeText(line);
    showCopiedToast(suffix === "2" ? "Copied duplicates (Secondary)" : "Copied duplicates");
  }
}

/* =========================
   Paste/Copy/Clear per panel
   ========================= */
async function pasteTextFor(suffix) {
  const input = document.getElementById(`inputText${suffix}`);
  const pasteBtn = document.getElementById(`pasteButton${suffix}`);
  if (!input) return;

  input.focus();
  if (pasteBtn) { pasteBtn.disabled = true; setTimeout(() => pasteBtn.disabled = false, 250); }

  try {
    if (navigator.permissions?.query) {
      try { await navigator.permissions.query({ name: "clipboard-read" }); } catch {}
    }

    const text = await navigator.clipboard.readText();
    if (text && text.trim()) {
      input.value = text.replace(/[\n\r\t]/g, ' ').replace(/\s+/g, ' ').trim();
      formatText();
      input.focus();
      return;
    }
  } catch (e) {}

  try {
    const ta = document.getElementById('pasteFallback');
    ta.value = "";
    ta.focus();

    const ok = document.execCommand('paste');
    const pasted = ta.value;

    input.focus();

    if (ok && pasted && pasted.trim()) {
      input.value = pasted.replace(/[\n\r\t]/g, ' ').replace(/\s+/g, ' ').trim();
      formatText();
      input.focus();
      return;
    }
  } catch (e) {}

  input.focus();
}

function copyTextFor(suffix) {
  const parts = panelState[suffix].currentOutputParts;
  if (parts.length) {
    navigator.clipboard.writeText(joinWithPrefix(parts, '|'));
    showCopiedToast(suffix === "2" ? "Copied (Secondary)" : "Copied");
  }
}

function clearPanel(suffix, skipConfirm=false) {
  if (!skipConfirm) { requestClearFor(suffix); return; }

  document.getElementById(`inputText${suffix}`).value = "";
  document.getElementById(`removeText${suffix}`).value = "";

  panelState[suffix].itemCounts = {};
  panelState[suffix].currentOutputParts = [];
  panelState[suffix].duplicateLine = "";

  formatText();
}

/* =========================
   CSV export
   - Secondary OFF: export primary only
   - Secondary ON: export both panels
   ========================= */
function exportCSV() {
  const split99On = !!document.getElementById('split99Toggle')?.checked;

  function buildSplit99CsvForSuffix(suffix, title) {
    const groupSize = 99;
    const parts = panelState[suffix].currentOutputParts;

    const groups = [];
    for (let i = 0; i < parts.length; i += groupSize) groups.push(parts.slice(i, i + groupSize));

    const groupCount = groups.length;
    const maxLen = Math.max(0, ...groups.map(g => g.length));

    const rows = [];
    rows.push([title]);
    const headerRow = [];
    for (let c = 0; c < groupCount; c++) headerRow.push(`Group ${c + 1}`);
    rows.push(headerRow);

    for (let r = 0; r < maxLen; r++) {
      const row = [];
      for (let c = 0; c < groupCount; c++) {
        const val = groups[c][r] ?? "";
        row.push(val ? withSloPrefix(val) : "");
      }
      rows.push(row);
    }
    rows.push([]);
    return rows.map(r => r.map(csvCell).join(",")).join("\n");
  }

  function buildNormalCsvForSuffix(suffix, title) {
    const headers = ["Sales number","Duplicated","Removed","Appears"];
    const rows = [];
    rows.push([title]);
    rows.push(headers);

    const counts = panelState[suffix].itemCounts || {};
    for (const [num,count] of Object.entries(counts)) {
      const dup = count > 1 ? "Yes" : "No";
      rows.push([withSloPrefix(num), dup, count>1 ? count-1 : 0, count]);
    }
    rows.push([]);
    return rows.map(r => r.map(csvCell).join(",")).join("\n");
  }

  if (!isSecondaryOn()) {
    const csv = split99On
      ? buildSplit99CsvForSuffix("", "Primary")
      : buildNormalCsvForSuffix("", "Primary");

    const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = split99On ? "The_Kyle_File_Batches.csv" : "The_Kyle_File.csv";
    link.click();
    return;
  }

  let csv = "";
  if (split99On) {
    csv += buildSplit99CsvForSuffix("", "Primary");
    csv += "\n";
    csv += buildSplit99CsvForSuffix("2", "Secondary");
  } else {
    csv += buildNormalCsvForSuffix("", "Primary");
    csv += "\n";
    csv += buildNormalCsvForSuffix("2", "Secondary");
  }

  const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = split99On ? "The_Kyle_File_Batches_Dual.csv" : "The_Kyle_File_Dual.csv";
  link.click();
}

/* =========================
   Startup + pipes + marquee
   ========================= */
window.onload = () => {
  try {
    const saved = localStorage.getItem('sp_darkmode');
    applyDarkMode(saved === '1');
  } catch { applyDarkMode(false); }

  // restore Secondary toggle
  try {
    const s = localStorage.getItem('sp_secondary');
    const on = (s === '1');
    const t = document.getElementById('secondaryToggle');
    if (t) t.checked = on;
  } catch {}

  // apply secondary UI state
  const on = isSecondaryOn();
  const panel = document.getElementById('panelSecondary');
  const container = document.getElementById('mainContainer');
  if (on) {
    panel.classList.remove('hidden');
    container.classList.add('dual');
  } else {
    panel.classList.add('hidden');
    container.classList.remove('dual');
  }

  const containerPipes = document.getElementById('pipeBackground');
  for (let i = 0; i < 50; i++) {
    const pipe = document.createElement('img');
    pipe.src = 'pipe.png';
    pipe.className = 'pipe';
    pipe.style.left = `${Math.random()*window.innerWidth}px`;
    pipe.style.top = `${-Math.random()*1000}px`;
    pipe.style.animationDuration = `${8 + Math.random()*4}s`;
    pipe.style.animationDelay = `${Math.random()*5}s`;
    containerPipes.appendChild(pipe);
  }

  fetch('motivation.txt')
    .then(r => r.text())
    .then(data => {
      const lines = data.split('\n').filter(l => l.trim());
      const msg = lines.length ? lines[Math.floor(Math.random()*lines.length)] : "Stay positive. Keep pushing forward!";
      startMarquee(msg);
    })
    .catch(() => startMarquee("Stay positive. Keep pushing forward!"));

  const input = document.getElementById('inputText');
  input?.focus();
  if (input) input.style.caretColor = "transparent";

  input?.addEventListener('paste', () => setTimeout(formatText, 0));
  document.getElementById('inputText2')?.addEventListener('paste', () => setTimeout(formatText, 0));

  _scheduleAutoClearCheck();
  formatText();
};

/* marquee */
function startMarquee(text) {
  const scroller = document.querySelector('.headline-scroller');
  const el = document.getElementById('headlineText');

  el.textContent = text;

  if (el._marqueeAnim) {
    try { el._marqueeAnim.cancel(); } catch {}
    el._marqueeAnim = null;
  }

  requestAnimationFrame(() => {
    const scrollWidth = scroller.clientWidth;
    const textWidth = el.scrollWidth;

    const fromX = scrollWidth;
    const toX = -textWidth;

    const distance = fromX - toX;
    const pxPerSec = 140;
    const duration = Math.max(9000, (distance / pxPerSec) * 1000);

    el._marqueeAnim = el.animate(
      [{ transform: `translateX(${fromX}px)` }, { transform: `translateX(${toX}px)` }],
      { duration, iterations: Infinity, easing: 'linear' }
    );
  });
}
</script>

</body>
</html>
