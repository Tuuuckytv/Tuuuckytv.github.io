<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sale Pipe Formatter</title>
  <link rel="icon" href="pipe.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --accent: #0f858e;
      --accent-light: #20a6b3;

      /* Light theme */
      --bg: #eaf4f5;
      --text: #333;
      --glass-bg: #ffffff;
      --shadow: 0 8px 25px rgba(0, 0, 0, 0.08);

      --border: #000;
      --muted: #666;
      --panel-border: #eee;
      --input-bg: #fff;
      --input-text: #000;
      --token-hover: rgba(15,133,142,0.1);
      --footer: #555;
      --pipe-opacity: 0.25;

      /* Win95 modal */
      --w95-border: #cfcfcf;
      --w95-inset1: #ffffff;
      --w95-inset2: #9a9a9a;
      --backdrop: rgba(0,0,0,0.25);

      /* ✅ Scrollbar theme (light) */
      --sb-track: rgba(0,0,0,0.06);
      --sb-thumb: rgba(15,133,142,0.45);
      --sb-thumb-hover: rgba(15,133,142,0.65);
      --sb-size: 10px;

      /* ✅ Split separator line */
      --split-line: rgba(0,0,0,0.14);
    }

    body.dark {
      --bg: #151c21;
      --text: #eef4f7;
      --glass-bg: #1c252b;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.42);

      --border: #3a4a54;
      --muted: #b4c2cb;
      --panel-border: #2d3b44;
      --input-bg: #151c21;
      --input-text: #eef4f7;

      --token-hover: rgba(32,166,179,0.20);
      --footer: #b4c2cb;
      --pipe-opacity: 0.17;

      --w95-border: #3a4a54;
      --w95-inset1: #26323a;
      --w95-inset2: #0f1418;
      --backdrop: rgba(0,0,0,0.50);

      --sb-track: rgba(255,255,255,0.06);
      --sb-thumb: rgba(32,166,179,0.35);
      --sb-thumb-hover: rgba(32,166,179,0.55);

      --split-line: rgba(255,255,255,0.14);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", sans-serif;
      background-color: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      position: relative;
      padding: 20px;
      transition: background-color 0.25s ease, color 0.25s ease;
    }

    .hidden { display: none !important; }

    /* ✅ Clean scrollbars (Chrome/Edge/Safari) */
    *::-webkit-scrollbar { width: var(--sb-size); height: var(--sb-size); }
    *::-webkit-scrollbar-track { background: var(--sb-track); border-radius: 999px; }
    *::-webkit-scrollbar-thumb {
      background: var(--sb-thumb);
      border-radius: 999px;
      border: 2px solid transparent;
      background-clip: padding-box;
    }
    *::-webkit-scrollbar-thumb:hover {
      background: var(--sb-thumb-hover);
      border: 2px solid transparent;
      background-clip: padding-box;
    }

    /* ✅ Clean scrollbars (Firefox) */
    * { scrollbar-width: thin; scrollbar-color: var(--sb-thumb) var(--sb-track); }

    /* ✅ FULLSCREEN "SPLIT TEXT" TOAST */
    .toast {
      position: fixed;
      inset: 0;
      z-index: 3000;
      pointer-events: none;
      display: grid;
      place-items: center;
      opacity: 0;
      transition: opacity 120ms ease;
    }

    .toast .toast-inner {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      background: color-mix(in srgb, var(--accent) 45%, transparent);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(2px);
      opacity: 0;
    }

    .toast.play { opacity: 1; }
    .toast.play .toast-inner { animation: toastOverlayFade 900ms ease forwards; }

    @keyframes toastOverlayFade {
      0%   { opacity: 0; }
      12%  { opacity: 1; }
      60%  { opacity: 1; }
      100% { opacity: 0; }
    }

    .toast-split {
      position: relative;
      z-index: 1;
      font-weight: 900;
      letter-spacing: 2px;
      text-transform: uppercase;
      font-size: clamp(28px, 5vw, 64px);
      color: #fff;
      text-shadow: 0 10px 30px rgba(0,0,0,0.35);
      padding: 10px 16px;
      text-align: center;
      user-select: none;
    }

    .toast-half {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      opacity: 0;
      transform: translateX(0);
      will-change: transform, opacity;
    }

    .toast-half.left  { clip-path: inset(0 50% 0 0); }
    .toast-half.right { clip-path: inset(0 0 0 50%); }

    .toast-base {
      position: relative;
      opacity: 0;
      transform: scale(0.98);
      will-change: opacity, transform;
    }

    .toast.play .toast-base { animation: toastBasePop 260ms ease forwards; }
    @keyframes toastBasePop {
      0%   { opacity: 0; transform: scale(0.98); }
      100% { opacity: 1; transform: scale(1); }
    }

    .toast.play .toast-half.left  { animation: toastSplitLeft 820ms ease forwards; }
    .toast.play .toast-half.right { animation: toastSplitRight 820ms ease forwards; }

    @keyframes toastSplitLeft {
      0%   { opacity: 0; transform: translateX(0); }
      22%  { opacity: 0; transform: translateX(0); }
      28%  { opacity: 1; transform: translateX(0); }
      100% { opacity: 0; transform: translateX(-260px); }
    }

    @keyframes toastSplitRight {
      0%   { opacity: 0; transform: translateX(0); }
      22%  { opacity: 0; transform: translateX(0); }
      28%  { opacity: 1; transform: translateX(0); }
      100% { opacity: 0; transform: translateX(260px); }
    }

    .toast.play .toast-base { animation: toastBaseHide 820ms ease forwards; }
    @keyframes toastBaseHide {
      0%   { opacity: 1; }
      24%  { opacity: 1; }
      30%  { opacity: 0; }
      100% { opacity: 0; }
    }

    /* === RAINING PIPES === */
    .pipe-background {
      position: absolute;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
    }

    .pipe {
      position: absolute;
      width: 30px;
      height: auto;
      animation: fall linear infinite;
      opacity: var(--pipe-opacity);
      filter: drop-shadow(0 4px 6px rgba(0,0,0,0.15));
    }

    @keyframes fall {
      0% { transform: translateY(-100px); opacity: 0; }
      10% { opacity: var(--pipe-opacity); }
      100% { transform: translateY(110vh); opacity: var(--pipe-opacity); }
    }

    /* === BUTTONS === */
    .button {
      padding: 0.75em 1.6em;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      cursor: pointer;
      color: var(--accent);
      transition: all 0.4s ease;
      font-size: 14px;
      position: relative;
      overflow: hidden;
      outline: 2px solid var(--accent);
      background: transparent;
      display: inline-block;
    }

    .button:hover {
      color: #fff;
      transform: scale(1.05);
      outline: 2px solid var(--accent-light);
      box-shadow: 2px 4px 10px -2px #0d6c75;
    }

    .button::before {
      content: "";
      position: absolute;
      left: -50px;
      top: 0;
      width: 0;
      height: 100%;
      background-color: var(--accent);
      transform: skewX(45deg);
      z-index: -1;
      transition: width 0.5s ease;
    }
    .button:hover::before { width: 250%; }

    .menu-buttons {
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 10;
      display: flex;
      gap: 10px;
    }

    .header-right {
      position: fixed;
      top: 15px;
      right: 15px;
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* === MOTIVATION SCROLLER === */
    .headline-scroller {
      position: fixed;
      top: 120px;
      left: 0;
      right: 0;
      width: 100%;
      overflow: hidden;
      z-index: 2;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      color: var(--accent);
      font-weight: 600;
      font-size: 16px;
      white-space: nowrap;
    }

    .headline-text { display: inline-block; will-change: transform; white-space: nowrap; }

    /* === MAIN CONTAINER === */
    .container {
      position: relative;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--glass-bg);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 30px 25px;
      width: 90%;
      max-width: 520px;
      text-align: center;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      animation: fadeIn 0.6s ease;
      transition: background-color 0.25s ease, box-shadow 0.25s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, -48%); }
      to { opacity: 1; transform: translate(-50%, -50%); }
    }

    h2 { margin-bottom: 8px; font-weight: 700; color: var(--accent); }
    p { margin-top: 0; font-size: 14px; color: var(--text); opacity: 0.95; }

    #qtyMarker { align-self: flex-start; font-size: 14px; color: var(--text); margin-bottom: 5px; }

    #inputText {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      outline: none;
      text-align: center;
      background: var(--input-bg);
      color: var(--input-text);
      caret-color: transparent;
      transition: background-color 0.25s ease, color 0.25s ease, border-color 0.25s ease;
    }
    #inputText:focus { outline: none; }

    .output-container {
      margin-top: 20px;
      max-height: 150px;
      overflow-y: auto;
      overflow-x: hidden;
      border: 1px solid var(--border);
      padding: 12px;
      background: var(--input-bg);
      text-align: center;
      font-weight: 600;
      font-size: 16px;
      border-radius: 10px;
      display: none;
      width: 100%;
      color: var(--accent);
      overflow-wrap: anywhere;
      word-break: break-word;
      transition: background-color 0.25s ease, border-color 0.25s ease;
    }

    #splitOutputsMount {
      width: 100%;
      display: none;
      max-height: 320px;
      overflow-y: auto;
      overflow-x: hidden;
      margin-top: 10px;
      padding-right: 8px;
      padding-bottom: 22px;
    }

    .button-container {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .split-under-main-buttons {
      width: 100%;
      height: 0;
      border-top: 1px solid var(--split-line);
      margin: 12px 0 2px;
      display: none;
    }

    .split-sep {
      width: 100%;
      height: 0;
      border-top: 1px solid var(--split-line);
      margin: 12px 0 6px;
    }

    .group-label {
      width: 100%;
      margin-top: 2px;
      margin-bottom: 4px;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--muted);
      text-align: left;
      padding: 0 2px;
      user-select: none;
    }

    /* === MODALS === */
    .remove-modal, .duplicate-modal {
      background: var(--glass-bg);
      border-radius: 10px;
      box-shadow: var(--shadow);
      padding: 15px;
      z-index: 3;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease, background-color 0.25s ease;
      position: absolute;
      border: 1px solid var(--panel-border);
    }

    .remove-modal.visible, .duplicate-modal.visible { opacity: 1; visibility: visible; }

    .remove-modal {
      top: 50%;
      left: 0;
      transform: translate(-115%, -50%);
      width: 260px;
      text-align: center;
    }

    .duplicate-modal {
      top: 50%;
      right: 0;
      transform: translate(115%, -50%);
      width: 260px;
      text-align: left;
      padding: 15px 15px 28px;
    }

    .duplicate-modal h4 { margin: 0 0 8px; font-size: 14px; color: var(--accent); }
    #duplicateList { font-size: 13px; color: var(--text); max-height: 120px; overflow-y: auto; }

    .toggle-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      border-bottom: 1px solid var(--panel-border);
      padding-bottom: 8px;
    }

    .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 28px;
    }

    .slider:before {
      content: "";
      position: absolute;
      height: 20px;
      width: 20px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    input:checked + .slider { background-color: var(--accent); }
    input:checked + .slider:before { transform: translateX(22px); }

    footer {
      position: fixed;
      bottom: 10px;
      right: 15px;
      font-size: 12px;
      color: var(--footer);
      font-style: italic;
      z-index: 2;
    }

    /* === CLICKABLE NUMBER TOKENS === */
    .num-token, .dup-token, .dup-line-token {
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 4px;
      transition: background-color 0.2s ease, color 0.2s ease;
    }

    .num-token:hover, .dup-token:hover, .dup-line-token:hover { background-color: var(--token-hover); }
    .num-token.highlight, .dup-token.highlight, .dup-line-token.highlight {
      background-color: var(--accent-light);
      color: #fff;
    }

    /* === DUPLICATE NUMBERS LINE SCROLL AREA === */
    #duplicateCopyWrapper {
      max-width: 240px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
    }

    #duplicateCopyText {
      max-height: 200px;
      max-width: 240px;
      overflow-y: auto;
      overflow-x: hidden;
      white-space: normal;
      display: block;
      padding: 6px 8px;
      padding-right: 12px;
      border: 1px solid var(--panel-border);
      border-radius: 6px;
      background: var(--input-bg);
      color: var(--text);
      transition: background-color 0.25s ease, border-color 0.25s ease, color 0.25s ease;
    }

    .dup-line-token { display: inline-block; margin-right: 4px; }

    /* ===== Windows 95 themed modals ===== */
    .w95-backdrop {
      position: fixed;
      inset: 0;
      background: var(--backdrop);
      z-index: 999;
    }

    .w95-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: min(420px, 92vw);
      z-index: 1000;

      background: var(--glass-bg);
      border: 2px solid var(--w95-border);
      box-shadow:
        0 0 0 1px var(--w95-inset1) inset,
        0 0 0 2px var(--w95-inset2) inset,
        0 10px 30px rgba(0,0,0,0.18);
      border-radius: 4px;
      transition: background-color 0.25s ease, border-color 0.25s ease;
    }

    .w95-titlebar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 8px;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      letter-spacing: 0.5px;
      user-select: none;
    }

    .w95-title { font-size: 13px; }

    .w95-x {
      width: 26px;
      height: 22px;
      padding: 0;
      border: 2px solid var(--w95-border);
      background: #dcdcdc;
      color: #111;
      font-weight: 800;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow:
        0 0 0 1px var(--w95-inset1) inset,
        0 0 0 2px var(--w95-inset2) inset;
    }

    .w95-x:hover { background: #efefef; }

    .w95-x:active {
      box-shadow:
        0 0 0 1px var(--w95-inset2) inset,
        0 0 0 2px var(--w95-inset1) inset;
      transform: translateY(1px);
    }

    body.dark .w95-x { background: var(--glass-bg); color: var(--text); }
    body.dark .w95-x:hover { background: color-mix(in srgb, var(--glass-bg) 80%, #ffffff 20%); }

    .w95-body { padding: 18px 16px 16px; text-align: center; color: var(--text); }

    .w95-message {
      font-size: 16px;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 14px;
    }

    .w95-btn-row {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
    }

    .w95-btn {
      min-width: 130px;
      padding: 10px 12px;
      font-size: 13px;
      font-weight: 800;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      cursor: pointer;
      background: #fff;
      color: var(--accent);
      border: 2px solid var(--w95-border);
      box-shadow:
        0 0 0 1px var(--w95-inset1) inset,
        0 0 0 2px var(--w95-inset2) inset;
      border-radius: 4px;
    }

    body.dark .w95-btn { background: var(--input-bg); color: var(--accent-light); }

    .w95-btn:active {
      box-shadow:
        0 0 0 1px var(--w95-inset2) inset,
        0 0 0 2px var(--w95-inset1) inset;
      transform: translateY(1px);
    }

    #removeText {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--input-text);
      transition: background-color 0.25s ease, color 0.25s ease, border-color 0.25s ease;
    }

    .toggle-pill {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid var(--panel-border);
      background: color-mix(in srgb, var(--glass-bg) 70%, transparent);
      box-shadow: var(--shadow);
    }
    .toggle-pill span {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
      opacity: 0.9;
      user-select: none;
      white-space: nowrap;
    }

    @media (max-width: 980px) {
      body { overflow: auto; }
      .remove-modal, .duplicate-modal {
        position: static;
        transform: none;
        width: 100%;
        max-width: 520px;
        margin: 10px 0 0 0;
      }
      .duplicate-modal { text-align: center; }
      .container { top: 0; left: 0; transform: none; margin: 120px auto 40px; }
    }
  </style>
</head>
<body>

  <div class="menu-buttons">
    <button class="button" onclick="location.href='/'">Home</button>
    <button class="button" onclick="location.href='date'">Dates</button>
    <button class="button" onclick="location.href='pipes'">Pipe Formatter</button>
  </div>

  <div class="header-right">
    <button class="button" onclick="exportCSV()">Export CSV</button>

    <div class="toggle-pill" title="Toggle dark mode">
      <span>Dark Mode</span>
      <label class="switch">
        <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
        <span class="slider"></span>
      </label>
    </div>
  </div>

  <div class="pipe-background" id="pipeBackground"></div>

  <div class="headline-scroller">
    <div class="headline-text" id="headlineText">Loading motivation...</div>
  </div>

  <div class="container">
    <div class="remove-modal" id="removeModal">
      <label for="removeText" style="font-weight:600;">Remove Order Numbers:</label>
      <div style="font-size: 12px; color: var(--muted); margin-bottom: 5px;">Don’t use | here</div>
      <input type="text" id="removeText" placeholder="Type numbers to remove" oninput="formatText()" />
    </div>

    <h2>Paste sales number here</h2>
    <p>Ensure spaces between each sales number</p>
    <div id="qtyMarker">Qty: 0</div>
    <input type="text" id="inputText" placeholder="Enter text here" oninput="formatText()" />

    <div class="button-container" id="mainButtons">
      <button class="button" id="pasteButton" onclick="pasteText()">Paste</button>
      <button class="button" id="copyButton" onclick="copyText()" style="display:none;">Copy</button>
      <button class="button" id="clearButton" onclick="requestClear()" style="display:none;">Clear</button>
    </div>

    <div id="splitUnderLine" class="split-under-main-buttons"></div>

    <div class="output-container" id="outputText"></div>
    <div id="splitOutputsMount"></div>

    <div class="duplicate-modal" id="duplicateModal">
      <h4>Removed Duplicates</h4>

      <div class="toggle-container">
        <span class="toggle-label">Keep Duplicates</span>
        <label class="switch">
          <input type="checkbox" id="keepDuplicatesToggle" onchange="formatText()">
          <span class="slider"></span>
        </label>
      </div>

      <div class="toggle-container">
        <span class="toggle-label">Split into 99s</span>
        <label class="switch">
          <input type="checkbox" id="split99Toggle" onchange="formatText()">
          <span class="slider"></span>
        </label>
      </div>

      <div id="duplicateList">None</div>

      <div id="duplicateCopyWrapper" class="hidden" style="margin-top:10px; font-size:12px;">
        <div id="duplicateCopyLabel" style="font-weight:600;">Duplicate numbers line:</div>
        <div id="duplicateCopyText">None</div>
        <button class="button" type="button" style="padding:4px 10px; font-size:11px;" onclick="copyDuplicates()">
          Copy duplicates
        </button>
      </div>
    </div>
  </div>

  <!-- === Less than 99 modal (Win95 style) === -->
  <div id="lt99Backdrop" class="w95-backdrop hidden" aria-hidden="true"></div>
  <div id="lt99Modal" class="w95-modal hidden" role="dialog" aria-modal="true"
       aria-labelledby="lt99Title" aria-describedby="lt99Msg">
    <div class="w95-titlebar">
      <div id="lt99Title" class="w95-title">Warning</div>
      <button class="w95-x" type="button" onclick="hideLt99Modal()" aria-label="Close">✕</button>
    </div>

    <div class="w95-body">
      <div id="lt99Msg" class="w95-message">Less than 99 dumb dumb</div>
      <button id="lt99CloseBtn" class="w95-close-big" type="button" onclick="hideLt99Modal()">CLOSE</button>
    </div>
  </div>

  <!-- ✅ Confirm Clear modal (Win95 style) -->
  <div id="clearBackdrop" class="w95-backdrop hidden" aria-hidden="true"></div>
  <div id="clearModal" class="w95-modal hidden" role="dialog" aria-modal="true"
       aria-labelledby="clearTitle" aria-describedby="clearMsg">
    <div class="w95-titlebar">
      <div id="clearTitle" class="w95-title">Confirm</div>
      <button class="w95-x" type="button" onclick="hideClearModal()" aria-label="Close">✕</button>
    </div>

    <div class="w95-body">
      <div id="clearMsg" class="w95-message">Clear everything?</div>

      <div class="w95-btn-row">
        <button class="w95-btn" type="button" onclick="confirmClear()">Yes, Clear</button>
        <button class="w95-btn" type="button" onclick="hideClearModal()">Cancel</button>
      </div>
    </div>
  </div>

  <footer>Please note qty may not reflect the actual number</footer>

  <!-- ✅ FULLSCREEN SPLIT TOAST -->
  <div id="toast" class="toast hidden" aria-hidden="true">
    <div class="toast-inner"></div>
    <div class="toast-split" aria-hidden="true">
      <div id="toastBase" class="toast-base">Copied!</div>
      <div id="toastLeft" class="toast-half left">Copied!</div>
      <div id="toastRight" class="toast-half right">Copied!</div>
    </div>
  </div>

<script>
let itemCounts = {};
let currentOutputParts = [];
let duplicateLine = "";

let lt99ModalOpen = false;
let clearModalOpen = false;

function show(el, showFlag) {
  if (showFlag) el.classList.add("visible");
  else el.classList.remove("visible");
}

function setSplitUnderLineVisible(isVisible) {
  const line = document.getElementById('splitUnderLine');
  if (!line) return;
  line.style.display = isVisible ? "block" : "none";
}

function showToast(msg="Copied!") {
  const toast = document.getElementById("toast");
  const base = document.getElementById("toastBase");
  const left = document.getElementById("toastLeft");
  const right = document.getElementById("toastRight");
  if (!toast || !base || !left || !right) return;

  base.textContent = msg;
  left.textContent = msg;
  right.textContent = msg;

  toast.classList.remove("hidden");
  toast.setAttribute("aria-hidden", "false");

  toast.classList.remove("play");
  void toast.offsetWidth;
  toast.classList.add("play");

  clearTimeout(showToast._t);
  showToast._t = setTimeout(() => {
    toast.classList.add("hidden");
    toast.setAttribute("aria-hidden", "true");
    toast.classList.remove("play");
  }, 1150);
}

function syncRemoveState() {
  const removeModal = document.getElementById('removeModal');
  const removeText = document.getElementById('removeText');
  removeModal.classList.remove('disabled-box');
  removeText.removeAttribute("disabled");
}

function applyDarkMode(isDark) {
  document.body.classList.toggle('dark', !!isDark);
  const t = document.getElementById('darkModeToggle');
  if (t) t.checked = !!isDark;
}

function toggleDarkMode() {
  const isDark = document.getElementById('darkModeToggle').checked;
  applyDarkMode(isDark);
  try { localStorage.setItem('sp_darkmode', isDark ? '1' : '0'); } catch {}
}

/* lt99 modal */
function showLt99Modal() {
  const modal = document.getElementById('lt99Modal');
  const backdrop = document.getElementById('lt99Backdrop');
  const closeBtn = document.getElementById('lt99CloseBtn');

  modal.classList.remove('hidden');
  backdrop.classList.remove('hidden');
  modal.setAttribute('aria-hidden', 'false');
  backdrop.setAttribute('aria-hidden', 'false');

  lt99ModalOpen = true;
  setTimeout(() => closeBtn.focus(), 0);
}

function hideLt99Modal() {
  const modal = document.getElementById('lt99Modal');
  const backdrop = document.getElementById('lt99Backdrop');

  modal.classList.add('hidden');
  backdrop.classList.add('hidden');
  modal.setAttribute('aria-hidden', 'true');
  backdrop.setAttribute('aria-hidden', 'true');

  lt99ModalOpen = false;

  const splitToggle = document.getElementById('split99Toggle');
  if (splitToggle) splitToggle.checked = false;

  formatText();

  const input = document.getElementById('inputText');
  if (input) input.focus();
}

/* Clear confirm modal */
function showClearModal() {
  const modal = document.getElementById('clearModal');
  const backdrop = document.getElementById('clearBackdrop');

  modal.classList.remove('hidden');
  backdrop.classList.remove('hidden');
  modal.setAttribute('aria-hidden', 'false');
  backdrop.setAttribute('aria-hidden', 'false');

  clearModalOpen = true;
}

function hideClearModal() {
  const modal = document.getElementById('clearModal');
  const backdrop = document.getElementById('clearBackdrop');

  modal.classList.add('hidden');
  backdrop.classList.add('hidden');
  modal.setAttribute('aria-hidden', 'true');
  backdrop.setAttribute('aria-hidden', 'true');

  clearModalOpen = false;

  const input = document.getElementById('inputText');
  if (input) input.focus();
}

function requestClear() {
  const hasInput = document.getElementById('inputText').value.trim().length > 0;
  const hasRemove = document.getElementById('removeText').value.trim().length > 0;
  const hasAny = hasInput || hasRemove ||
    document.getElementById('keepDuplicatesToggle').checked ||
    document.getElementById('split99Toggle').checked;

  if (!hasAny) return;
  showClearModal();
}

function confirmClear() {
  hideClearModal();
  clearText(true);
}

/* Enter/Esc modal controls */
document.addEventListener('keydown', (e) => {
  if (lt99ModalOpen) {
    if (e.key === 'Enter' || e.key === 'Escape') { e.preventDefault(); hideLt99Modal(); }
    return;
  }
  if (clearModalOpen) {
    if (e.key === 'Enter') { e.preventDefault(); confirmClear(); }
    if (e.key === 'Escape') { e.preventDefault(); hideClearModal(); }
  }
});

/* ✅ NEW: Force "Sales number" values to stay as TEXT in CSV (prevents 6.8E+10) */
function csvCell(v) {
  const s = String(v ?? "");
  // If it looks like a long-ish number, output as ="123..." so Excel keeps it as text.
  // (Also safe for leading zeros.)
  const looksNumeric = /^[0-9]+$/.test(s);
  if (looksNumeric && s.length >= 10) {
    return `"=""${s.replaceAll('"','""')}"""`;
  }
  return `"${s.replaceAll('"','""')}"`;
}

/* Main formatter */
function formatText() {
  const input = document.getElementById('inputText').value;

  const output = document.getElementById('outputText');
  const splitMount = document.getElementById('splitOutputsMount');

  const copyBtn = document.getElementById('copyButton');
  const clearBtn = document.getElementById('clearButton');
  const pasteBtn = document.getElementById('pasteButton');
  const qty = document.getElementById('qtyMarker');

  const removeModal = document.getElementById('removeModal');
  const duplicateModal = document.getElementById('duplicateModal');
  const duplicateListDiv = document.getElementById('duplicateList');

  const split99 = document.getElementById('split99Toggle').checked;

  syncRemoveState();

  const removeInput = document.getElementById('removeText').value.trim();

  if (input.trim() === "") {
    output.style.display = "none";
    output.innerHTML = "";

    splitMount.style.display = "none";
    splitMount.innerHTML = "";

    setSplitUnderLineVisible(false);

    copyBtn.style.display = "none";
    clearBtn.style.display = "none";
    pasteBtn.style.display = "inline-block";
    qty.innerText = "Qty: 0";
    show(removeModal, false);
    show(duplicateModal, false);

    duplicateListDiv.innerText = "None";
    renderDuplicateLine([]);

    currentOutputParts = [];
    duplicateLine = "";

    if (lt99ModalOpen) hideLt99Modal();

    return;
  }

  pasteBtn.style.display = "none";
  copyBtn.style.display = "inline-block";
  clearBtn.style.display = "inline-block";

  show(removeModal, true);
  show(duplicateModal, true);

  let allParts = input
    .replace(/\|/g, ' ')
    .trim()
    .split(/\s+/)
    .filter(p => p);

  const counts = {};
  allParts.forEach(p => counts[p] = (counts[p] || 0) + 1);
  itemCounts = counts;

  const duplicateBlocks = [];
  for (const n in counts) {
    if (counts[n] > 1) {
      duplicateBlocks.push(`
        <div>
          <span class="dup-token" data-num="${n}" onclick="highlightNumber('${n}')">
            ${n}
          </span><br>
          Removed x${counts[n]-1}<br>
          Appears x${counts[n]}
        </div>
      `);
    }
  }

  duplicateListDiv.innerHTML =
    duplicateBlocks.length ? duplicateBlocks.join('') : "None";

  const duplicateNumbers = Object.keys(counts).filter(n => counts[n] > 1);
  duplicateLine = duplicateNumbers.join('|');
  renderDuplicateLine(duplicateNumbers);

  const keepDuplicates = document.getElementById('keepDuplicatesToggle').checked;
  let parts = keepDuplicates ? allParts : Object.keys(counts);

  if (removeInput) {
    const removeSet = new Set(removeInput.split(/[\s,|]+/).filter(Boolean));
    parts = parts.filter(p => !removeSet.has(p));
  }

  currentOutputParts = [...parts];
  qty.innerText = `Qty: ${parts.length}`;

  if (split99 && parts.length < 99) {
    showLt99Modal();

    splitMount.style.display = "none";
    splitMount.innerHTML = "";

    setSplitUnderLineVisible(false);

    output.style.display = "none";
    output.innerHTML = "";
    return;
  } else {
    if (lt99ModalOpen) hideLt99Modal();
  }

  if (!split99) {
    splitMount.style.display = "none";
    splitMount.innerHTML = "";

    setSplitUnderLineVisible(false);

    output.style.display = "block";
    renderOutput(parts);
  } else {
    output.style.display = "none";
    output.innerHTML = "";

    splitMount.style.display = "block";
    renderSplitOutputs(parts);

    setSplitUnderLineVisible(parts.length > 99);
  }
}

function renderOutput(parts) {
  const outEl = document.getElementById('outputText');
  outEl.innerHTML = "";
  parts.forEach((p, idx) => {
    const span = document.createElement('span');
    span.className = 'num-token';
    span.dataset.num = p;
    span.textContent = p;
    span.onclick = () => highlightNumber(p);
    outEl.appendChild(span);
    if (idx < parts.length-1)
      outEl.appendChild(document.createTextNode('|'));
  });
}

function renderSplitOutputs(parts) {
  const mount = document.getElementById('splitOutputsMount');
  mount.innerHTML = "";

  const groupSize = 99;
  const groups = [];
  for (let i = 0; i < parts.length; i += groupSize) {
    groups.push(parts.slice(i, i + groupSize));
  }

  groups.forEach((group, idx) => {
    if (idx > 0) {
      const sep = document.createElement('div');
      sep.className = 'split-sep';
      mount.appendChild(sep);
    }

    const label = document.createElement('div');
    label.className = 'group-label';
    label.textContent = `Group ${idx + 1} (${group.length})`;
    mount.appendChild(label);

    const outBox = document.createElement('div');
    outBox.className = 'output-container';
    outBox.style.display = "block";

    group.forEach((p, j) => {
      const span = document.createElement('span');
      span.className = 'num-token';
      span.dataset.num = p;
      span.textContent = p;
      span.onclick = () => highlightNumber(p);
      outBox.appendChild(span);
      if (j < group.length - 1) outBox.appendChild(document.createTextNode('|'));
    });

    const btnWrap = document.createElement('div');
    btnWrap.className = 'button-container';
    btnWrap.style.marginTop = "10px";

    const copyOne = document.createElement('button');
    copyOne.className = 'button';
    copyOne.type = 'button';
    copyOne.textContent = `Copy Batch ${idx + 1}`;
    copyOne.onclick = () => {
      navigator.clipboard.writeText(group.join('|'));
      showToast(`Copied ${idx + 1}!`);
    };

    btnWrap.appendChild(copyOne);

    mount.appendChild(outBox);
    mount.appendChild(btnWrap);
  });
}

function renderDuplicateLine(dups) {
  const wrapper = document.getElementById('duplicateCopyWrapper');
  const container = document.getElementById('duplicateCopyText');

  if (!dups.length) {
    wrapper.classList.add("hidden");
    container.textContent = "None";
    return;
  }

  wrapper.classList.remove("hidden");

  container.innerHTML = "";
  dups.forEach((n, idx) => {
    const span = document.createElement('span');
    span.className = 'dup-line-token';
    span.dataset.num = n;
    span.textContent = n;
    span.onclick = () => highlightNumber(n);
    container.appendChild(span);
    if (idx < dups.length-1)
      container.appendChild(document.createTextNode('|'));
  });
}

function highlightNumber(value) {
  const tokens = document.querySelectorAll('.num-token, .dup-token, .dup-line-token');
  tokens.forEach(t => {
    t.classList.toggle('highlight', t.dataset.num === value);
  });
}

function copyDuplicates() {
  if (duplicateLine) {
    navigator.clipboard.writeText(duplicateLine);
    showToast("Copied duplicates!");
  }
}

window.onload = () => {
  try {
    const saved = localStorage.getItem('sp_darkmode');
    applyDarkMode(saved === '1');
  } catch { applyDarkMode(false); }

  const container = document.getElementById('pipeBackground');
  for (let i = 0; i < 50; i++) {
    const pipe = document.createElement('img');
    pipe.src = 'pipe.png';
    pipe.className = 'pipe';
    pipe.style.left = `${Math.random()*window.innerWidth}px`;
    pipe.style.top = `${-Math.random()*1000}px`;
    pipe.style.animationDuration = `${8 + Math.random()*4}s`;
    pipe.style.animationDelay = `${Math.random()*5}s`;
    container.appendChild(pipe);
  }

  fetch('motivation.txt')
    .then(r => r.text())
    .then(data => {
      const lines = data.split('\n').filter(l => l.trim());
      const msg = lines.length ? lines[Math.floor(Math.random()*lines.length)] : "Stay positive. Keep pushing forward!";
      startMarquee(msg);
    })
    .catch(() => startMarquee("Stay positive. Keep pushing forward!"));

  const input = document.getElementById('inputText');
  input.focus();
  input.style.caretColor = "transparent";
};

function startMarquee(text) {
  const el = document.getElementById('headlineText');
  el.textContent = text;

  const scroller = document.querySelector('.headline-scroller');
  const scrollWidth = scroller.offsetWidth;
  const textWidth = el.offsetWidth;

  el.animate([
    { transform: `translateX(${scrollWidth}px)` },
    { transform: `translateX(-${textWidth}px)` }
  ], {
    duration: 18000,
    iterations: Infinity,
    easing: 'linear'
  });
}

async function pasteText() {
  try {
    const text = await navigator.clipboard.readText();
    if (text) {
      document.getElementById('inputText').value = text
        .replace(/[\n\r\t]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
      formatText();
    }
  } catch {
    alert("Clipboard access denied.");
  }
}

function copyText() {
  if (currentOutputParts.length) {
    navigator.clipboard.writeText(currentOutputParts.join('|'));
    showToast("Copied output!");
  }
}

function clearText(skipConfirm=false) {
  if (!skipConfirm) { requestClear(); return; }

  document.getElementById('inputText').value = "";
  document.getElementById('removeText').value = "";
  document.getElementById('keepDuplicatesToggle').checked = false;
  document.getElementById('split99Toggle').checked = false;

  syncRemoveState();

  if (lt99ModalOpen) hideLt99Modal();

  formatText();
}

function exportCSV() {
  const split99On = document.getElementById('split99Toggle').checked;

  if (split99On) {
    const groupSize = 99;

    const groups = [];
    for (let i = 0; i < currentOutputParts.length; i += groupSize) {
      groups.push(currentOutputParts.slice(i, i + groupSize));
    }

    const groupCount = groups.length;
    const maxLen = Math.max(0, ...groups.map(g => g.length));

    const rows = [];
    const headerRow = [];
    for (let c = 0; c < groupCount; c++) headerRow.push(`Group ${c + 1}`);
    rows.push(headerRow);

    for (let r = 0; r < maxLen; r++) {
      const row = [];
      for (let c = 0; c < groupCount; c++) {
        row.push(groups[c][r] ?? "");
      }
      rows.push(row);
    }

    const csv = rows.map(r => r.map(csvCell).join(",")).join("\n");

    const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "The_Kyle_File_Batches.csv";
    link.click();
    return;
  }

  const headers = ["Sales number","Duplicated","Removed","Appears"];
  const rows = [headers];

  for (const [num,count] of Object.entries(itemCounts)) {
    const dup = count > 1 ? "Yes" : "No";
    rows.push([num, dup, count>1 ? count-1 : 0, count]);
  }

  const csv = rows.map(r => r.map(csvCell).join(",")).join("\n");

  const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "The_Kyle_File.csv";
  link.click();
}
</script>

</body>
</html>
